#!/usr/bin/env zsh
THEMES_DIR="$HOME/.config/themes"
STATE_FILE="$HOME/.local/state/theme"

usage() {
  echo "Usage: switch-theme <theme>"
  echo "Themes: $(ls "$THEMES_DIR"/*.sh 2>/dev/null | xargs -n1 basename | sed 's/\.sh$//' | tr '\n' ' ')"
  exit 1
}

[[ $# -eq 1 ]] || usage
theme="$1"
theme_file="$THEMES_DIR/${theme}.sh"
[[ -f "$theme_file" ]] || { echo "Unknown theme: $theme (no $theme_file)"; exit 1; }

# Source palette
source "$theme_file"

# 1. Persist state
mkdir -p "$(dirname "$STATE_FILE")"
echo "$theme" > "$STATE_FILE"

# 2. Ghostty
mkdir -p "$HOME/.config/ghostty"
cat > "$HOME/.config/ghostty/theme.conf" << EOF
theme = "${THEME_GHOSTTY_NAME}"
background = ${THEME_BG}
foreground = ${THEME_FG}
EOF

# 3. Tmux active theme (generated from palette vars)
mkdir -p "$HOME/.config/tmux"
cat > "$HOME/.config/tmux/active.tmuxtheme" << EOF
set -g status-style "fg=${THEME_FG},bg=default"
set -g message-style "fg=${THEME_CYAN},bg=${THEME_GRAY}"
set -g message-command-style "fg=${THEME_CYAN},bg=${THEME_GRAY}"
set -g pane-border-style "fg=${THEME_GRAY}"
set -g pane-active-border-style "fg=${THEME_BLUE}"
set -g status-left-length 30
set -g status-left "#[fg=${THEME_BG},bg=${THEME_MAGENTA},bold] #{=20:session_name} "
set -g status-left-style "fg=${THEME_BG},bg=${THEME_MAGENTA}"
set -g status-right "#[fg=${THEME_FG},bg=${THEME_GRAY}] %Y-%m-%d %H:%M "
set -g status-right-style "fg=${THEME_FG},bg=default"
set-window-option -g window-status-style "fg=${THEME_DIM},bg=default"
set-window-option -g window-status-current-style "fg=${THEME_ORANGE},bg=default,bold"
set-window-option -g window-status-format "  #(echo '#{pane_current_command}')"
set-window-option -g window-status-current-format "  #(echo '#{pane_current_command}')"
set-window-option -g clock-mode-colour "${THEME_BLUE}"
set-window-option -g mode-style "fg=${THEME_MAGENTA},bg=${THEME_GRAY},bold"
EOF

# 4. Live-reload tmux
if tmux info &>/dev/null 2>&1; then
  tmux source-file "$HOME/.config/tmux/active.tmuxtheme"
fi

# 5. Claude Code theme
if [[ -f "$HOME/.claude/settings.json" ]] && command -v jq &>/dev/null; then
  if [[ "$theme" == *light* ]]; then
    claude_theme="light"
  else
    claude_theme="dark"
  fi
  jq --arg t "$claude_theme" '.theme = $t' "$HOME/.claude/settings.json" > /tmp/claude-settings.json \
    && mv /tmp/claude-settings.json "$HOME/.claude/settings.json"
fi

echo "âœ“ Switched to: $theme"
echo "  Ghostty + tmux + Claude Code: updated. Open a new shell for fzf colors."
